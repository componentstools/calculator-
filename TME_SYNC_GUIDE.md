# üîÑ TME –ú–ê–°–°–û–í–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø - –≠–¢–ê–ü 2

## üìä –°–¢–ê–¢–£–°

‚úÖ **–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã:**
- –ê—Ä—Ç–∏–∫—É–ª–æ–≤: 979,904
- TME Token: `9c403f793a7fca44dd5d8b0dc5d8b02f3b4a6c0eecf3f943b08a4`
- –§–∞–π–ª: `SKU_all.txt`

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢

### **–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞**

```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç–µ SKU_all.txt –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp SKU_all.txt root@your-server:/var/www/calculator-api/

# –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ
nano /var/www/calculator-api/SKU_all.txt
# –í—Å—Ç–∞–≤—å—Ç–µ –∞—Ä—Ç–∏–∫—É–ª—ã
```

### **–®–∞–≥ 2: –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

```bash
cd /var/www/calculator-api

# –ü–û–õ–ù–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–≤—Å–µ 980–ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤)
php tme_mass_sync.php --file=SKU_all.txt --token=9c403f793a7fca44dd5d8b0dc5d8b02f3b4a6c0eecf3f943b08a4

# –° —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
php tme_mass_sync.php --file=SKU_all.txt --batch=50 --token=9c403f793a7fca44dd5d8b0dc5d8b02f3b4a6c0eecf3f943b08a4
```

---

## üìà –ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢

### **1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞**
```
üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞: 979904
‚è±Ô∏è  –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: 2025-11-02 23:30:00
üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...
```

### **2. –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
```
üì¶ –ü–∞–∫–µ—Ç 1/49000 (20 –∞—Ä—Ç–∏–∫—É–ª–æ–≤)
[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 20.5% | 200000/979904 | ‚ö° 15.2/—Å | ‚è±Ô∏è  14 —á –æ—Å—Ç–∞–ª–æ—Å—å
```

### **3. –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç**
```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò               
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä –í—Å–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤:        979904
‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ:     950000
‚ùå –û—à–∏–±–æ–∫:                 5000
‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ:              24904
‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è:            18 —á 30 –º–∏–Ω
‚ö° –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:       14.8 –∞—Ä—Ç–∏–∫—É–ª–æ–≤/—Å–µ–∫
üíæ –î–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∞–Ω–æ:        ~1855 MB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

---

## ‚öôÔ∏è –ü–ê–†–ê–ú–ï–¢–†–´

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|--------------|
| `--file` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏ | `SKU_all.txt` |
| `--batch` | –ê—Ä—Ç–∏–∫—É–ª–æ–≤ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ | `20` |
| `--token` | TME API Token | –≤–∞—à —Ç–æ–∫–µ–Ω |

---

## ‚è±Ô∏è –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò

### **–§–∞–∫—Ç–æ—Ä—ã:**
- –ê—Ä—Ç–∏–∫—É–ª–æ–≤: **979,904**
- Rate limit: **1 –∑–∞–ø—Ä–æ—Å/—Å–µ–∫** (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
- –ü–∞–∫–µ—Ç: **20 –∞—Ä—Ç–∏–∫—É–ª–æ–≤/–∑–∞–ø—Ä–æ—Å**
- –ó–∞–ø—Ä–æ—Å–æ–≤: **49,000**

### **–†–∞—Å—á–µ—Ç:**
```
–í—Ä–µ–º—è = –ó–∞–ø—Ä–æ—Å–æ–≤ √ó –ó–∞–¥–µ—Ä–∂–∫–∞
–í—Ä–µ–º—è = 49,000 √ó 1 —Å–µ–∫ = 49,000 —Å–µ–∫ ‚âà 13.6 —á–∞—Å–æ–≤
```

### **–° —É—á–µ—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```
–†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: ~14-18 —á–∞—Å–æ–≤
```

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç 1:** –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–∫–µ—Ç –¥–æ 50
```
php tme_mass_sync.php --batch=50
# –í—Ä–µ–º—è: ~8-10 —á–∞—Å–æ–≤
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (3 –ø—Ä–æ—Ü–µ—Å—Å–∞)
```bash
# –†–∞–∑–±–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ 3 —á–∞—Å—Ç–∏
split -l 327000 SKU_all.txt SKU_part_

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
php tme_mass_sync.php --file=SKU_part_aa &
php tme_mass_sync.php --file=SKU_part_ab &
php tme_mass_sync.php --file=SKU_part_ac &

# –í—Ä–µ–º—è: ~5-6 —á–∞—Å–æ–≤
```

---

## üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –ù–ê–î–ï–ñ–ù–û–°–¢–¨

### **Rate Limiting**
```php
// –í –∫–æ–¥–µ: 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É
private $requestDelay = 1.0;
```

TME –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ —Ç–∞–∫–æ–º –ª–∏–º–∏—Ç–µ.

### **–ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞–∫–µ—Ç–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

### **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**
```sql
ON CONFLICT (tme_symbol) DO UPDATE ...
```
–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—ã, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç.

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
tail -f /var/log/tme_sync.log
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–†–û–¶–ï–°–°–ê

### **–í–æ –≤—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
php tme_mass_sync.php --file=SKU_all.txt

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î
watch -n 5 'psql -U calculator_user -d calculator_db -c "SELECT COUNT(*) FROM parts WHERE tme_symbol IS NOT NULL"'

# –¢–µ—Ä–º–∏–Ω–∞–ª 3: –õ–æ–≥–∏
tail -f /var/log/tme_sync.log
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏:**
```bash
# –°–∫–æ–ª—å–∫–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
psql -U calculator_user -d calculator_db -c "SELECT COUNT(*) as loaded FROM parts WHERE tme_last_sync > NOW() - INTERVAL '1 hour'"
```

---

## üîß TROUBLESHOOTING

### **–û—à–∏–±–∫–∞: Connection timeout**
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å timeout –≤ —Å–∫—Ä–∏–ø—Ç–µ
CURLOPT_TIMEOUT => 60
```

### **–û—à–∏–±–∫–∞: Too many requests**
```bash
# –£–º–µ–Ω—å—à–∏—Ç—å batch –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å delay
php tme_mass_sync.php --batch=10
```

### **–û—à–∏–±–∫–∞: Memory limit**
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç PHP
php -d memory_limit=512M tme_mass_sync.php --file=SKU_all.txt
```

### **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**

TME —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞: Ctrl+C

# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
php tme_mass_sync.php --file=SKU_all.txt
# –ü—Ä–æ–ø—É—Å—Ç–∏—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã
```

---

## üìà –ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**

```sql
-- –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
SELECT COUNT(*) FROM parts WHERE tme_symbol IS NOT NULL;

-- –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
SELECT category, COUNT(*) FROM parts GROUP BY category;

-- –° —Ü–µ–Ω–∞–º–∏
SELECT COUNT(*) FROM parts WHERE tme_price_eur > 0;

-- –í –Ω–∞–ª–∏—á–∏–∏
SELECT COUNT(*) FROM parts WHERE tme_availability > 0;
```

### **2. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è**

```sql
-- –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü
ANALYZE parts;
ANALYZE manufacturers;

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
VACUUM ANALYZE;
```

### **3. –ë—ç–∫–∞–ø**

```bash
pg_dump -U calculator_user calculator_db | gzip > backup_after_tme_sync_$(date +%Y%m%d).sql.gz
```

---

## üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

```bash
sudo crontab -e
```

–î–æ–±–∞–≤–∏—Ç—å:
```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
0 */6 * * * cd /var/www/calculator-api && php tme_mass_sync.php --file=SKU_all.txt >> /var/log/tme_sync_cron.log 2>&1
```

**–ò–ª–∏ –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ):**
```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å —Ç–æ–ø-1000 –∞—Ä—Ç–∏–∫—É–ª–æ–≤
psql -U calculator_user -d calculator_db -c "COPY (SELECT mpn FROM parts ORDER BY calculation_count DESC LIMIT 1000) TO '/tmp/top_parts.txt'"

# –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å
0 * * * * cd /var/www/calculator-api && php tme_mass_sync.php --file=/tmp/top_parts.txt >> /var/log/tme_sync_top.log 2>&1
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
4. ‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ **–≠–¢–ê–ü–£ 3: Octopart**

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

**–õ–æ–≥–∏:**
- `/var/log/tme_sync.log` - –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥
- `/var/log/tme_sync_cron.log` - –ª–æ–≥–∏ cron –∑–∞–¥–∞—á

**–ü—Ä–æ–≤–µ—Ä–∫–∞ TME API:**
```bash
curl -X POST https://api.tme.eu/Products/GetProducts.json \
  -H "Content-Type: application/json" \
  -d '{
    "Token": "9c403f793a7fca44dd5d8b0dc5d8b02f3b4a6c0eecf3f943b08a4",
    "Country": "RU",
    "Language": "RU",
    "SymbolList": ["STM32F103C8T6"]
  }'
```

---

‚úÖ **–ì–û–¢–û–í–û –ö –ó–ê–ü–£–°–ö–£!**

–°–ª–µ–¥—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å—Ç–∏—Ç –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:
```bash
php tme_mass_sync.php --file=SKU_all.txt --token=9c403f793a7fca44dd5d8b0dc5d8b02f3b4a6c0eecf3f943b08a4
```
